# =============================================================================
# InfoHub Telegram Bot - Docker Image
# Оптимизировано для Render Free Tier (минимальный размер, быстрый старт)
# =============================================================================

# -----------------------------------------------------------------------------
# БАЗОВЫЙ ОБРАЗ
# Используем slim-версию для уменьшения размера (~120MB вместо ~900MB)
# -----------------------------------------------------------------------------
FROM python:3.10-slim

# -----------------------------------------------------------------------------
# МЕТАДАННЫЕ (для отладки и документации)
# -----------------------------------------------------------------------------
LABEL maintainer="infhub-dev"
LABEL description="Telegram bot aggregator - InfoHub MVP"
LABEL version="1.0.0"
LABEL python_version="3.10"

# -----------------------------------------------------------------------------
# ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ (настраиваются до установки зависимостей)
# -----------------------------------------------------------------------------

# Python не буферизирует вывод (логи видны в реальном времени в Render)
ENV PYTHONUNBUFFERED=1

# Не создавать .pyc файлы (экономия места, не нужно на production)
ENV PYTHONDONTWRITEBYTECODE=1

# Путь к приложению внутри контейнера
ENV APP_HOME=/app

# Уровень логирования по умолчанию
ENV LOG_LEVEL=INFO

# -----------------------------------------------------------------------------
# РАБОЧАЯ ДИРЕКТОРИЯ
# -----------------------------------------------------------------------------
WORKDIR ${APP_HOME}

# -----------------------------------------------------------------------------
# УСТАНОВКА ЗАВИСИМОСТЕЙ
# Кэшируем слой с requirements.txt для ускорения повторных сборок
# -----------------------------------------------------------------------------

# Копируем только requirements.txt первым слоем
# При изменении кода этот слой не пересобирается (экономия времени)
COPY requirements.txt .

# Обновляем pip и устанавливаем зависимости
# --no-cache-dir уменьшает размер образа (не сохраняет кэш pip)
# --upgrade pip для безопасности (последние патчи)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# КОПИРОВАНИЕ ИСХОДНОГО КОДА
# .dockerignore должен исключать лишние файлы (см. ниже)
# -----------------------------------------------------------------------------
COPY . .

# -----------------------------------------------------------------------------
# НАСТРОЙКА ПРАВ ДОСТУПА
# Render запускает контейнер от non-root пользователя (безопасность)
# -----------------------------------------------------------------------------

# Создаём директорию для данных (если потребуется)
RUN mkdir -p ${APP_HOME}/data && \
    chmod -R 755 ${APP_HOME}

# -----------------------------------------------------------------------------
# ПОРТ (для webhook-режима, если понадобится в будущем)
# polling-режим не требует открытия портов, но оставим для совместимости
# -----------------------------------------------------------------------------
EXPOSE 8080

# -----------------------------------------------------------------------------
# HEALTH CHECK (опционально, для мониторинга доступности)
# Render поддерживает health checks для автоматического перезапуска
# -----------------------------------------------------------------------------
# HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
#   CMD python -c "import sys; sys.exit(0)" || exit 1

# -----------------------------------------------------------------------------
# ТОЧКА ВХОДА
# Запускаем бота в polling-режиме (aiogram 3.x)
# -----------------------------------------------------------------------------
CMD ["python", "bot.py"]

# =============================================================================
# АЛЬТЕРНАТИВНЫЕ КОНФИГУРАЦИИ (раскомментируйте при необходимости)
# =============================================================================

# -----------------------------------------------------------------------------
# ВАРИАНТ 1: Multi-stage build (ещё меньший размер образа ~50MB)
# -----------------------------------------------------------------------------
# # Stage 1: Build
# FROM python:3.10-slim as builder
# WORKDIR /app
# COPY requirements.txt .
# RUN pip install --no-cache-dir --user -r requirements.txt
# 
# # Stage 2: Runtime
# FROM python:3.10-slim
# ENV PYTHONUNBUFFERED=1 PYTHONDONTWRITEBYTECODE=1
# WORKDIR /app
# COPY --from=builder /root/.local /root/.local
# COPY --from=builder /app .
# ENV PATH=/root/.local/bin:$PATH
# CMD ["python", "bot.py"]

# -----------------------------------------------------------------------------
# ВАРИАНТ 2: С health check endpoint (для production мониторинга)
# -----------------------------------------------------------------------------
# Добавьте в bot.py endpoint /health и раскомментируйте:
# HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
#   CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# -----------------------------------------------------------------------------
# ВАРИАНТ 3: С non-root пользователем (повышенная безопасность)
# -----------------------------------------------------------------------------
# RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
# USER appuser
# CMD ["python", "bot.py"]

# =============================================================================
# СОВЕТЫ ДЛЯ RENDER FREE TIER
# =============================================================================
# 1. Размер образа: целевой < 200MB (slim образ ~120MB + зависимости ~50MB)
# 2. Время сборки: целевое < 5 минут (кэшируйте requirements.txt слой)
# 3. Время запуска: целевое < 30 секунд (избегайте тяжёлых инициализаций)
# 4. Память: целевое < 512MB (Render Free Tier даёт 512MB RAM)
# 5. CPU: целевое < 0.5 cores (Render Free Tier даёт shared CPU)